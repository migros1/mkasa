<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Migros Akıllı Ürün Arama ve Yönetim Sistemi">
    <meta name="theme-color" content="#ff6f00">
    <title>Migros Akıllı Ürün Sistemi Pro</title>
    
    <!-- Harici Kaynaklar -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" rel="stylesheet">
    
    <style>
        /* Ana Değişkenler ve Temalar */
        :root {
            --primary-color: #ff6f00;
            --primary-light: #ff9e40;
            --primary-dark: #c43e00;
            --secondary-color: #2196F3;
            --success-color: #4CAF50;
            --warning-color: #FFC107;
            --error-color: #f44336;
            --info-color: #2196F3;
            --background-color: #f8f9fa;
            --surface-color: #ffffff;
            --text-primary: #212121;
            --text-secondary: #757575;
            --border-color: #e0e0e0;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --transition-speed: 0.3s;
            --spacing-unit: 8px;
            --border-radius: 12px;
            --header-height: 64px;
            --sidebar-width: 280px;
        }

        [data-theme="dark"] {
            --background-color: #121212;
            --surface-color: #1e1e1e;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --border-color: #333333;
            --shadow-color: rgba(0, 0, 0, 0.3);
        }

        /* Temel Stiller */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Roboto', sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 16px;
            overflow-x: hidden;
            transition: background-color var(--transition-speed);
        }

        /* Ana Container */
        .app-container {
            display: grid;
            grid-template-columns: var(--sidebar-width) 1fr;
            grid-template-rows: var(--header-height) 1fr;
            min-height: 100vh;
        }

        /* Header Stili */
        .app-header {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px var(--shadow-color);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 100%;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .header-center {
            flex: 1;
            max-width: 600px;
            margin: 0 20px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        /* Arama Çubuğu Stili */
        .search-wrapper {
            position: relative;
            width: 100%;
        }

        .search-bar {
            width: 100%;
            padding: 12px 40px;
            border: none;
            border-radius: 24px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-size: 1rem;
            transition: all var(--transition-speed);
        }

        .search-bar::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .search-bar:focus {
            background: white;
            color: var(--text-primary);
            box-shadow: 0 0 0 2px var(--primary-dark);
            outline: none;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.7);
            pointer-events: none;
        }

        .search-bar:focus + .search-icon {
            color: var(--primary-color);
        }

        /* Header Butonları */
        .header-button {
            background: none;
            border: none;
            color: white;
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color var(--transition-speed);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        .header-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Yan Menü */
        .side-menu {
            background: var(--surface-color);
            width: var(--sidebar-width);
            border-right: 1px solid var(--border-color);
            padding: 20px 0;
            height: calc(100vh - var(--header-height));
            position: sticky;
            top: var(--header-height);
            overflow-y: auto;
            transition: transform var(--transition-speed);
        }

        .menu-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .menu-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
        }

        .menu-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .menu-items {
            list-style: none;
        }

        .menu-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-speed);
        }

        .menu-item:hover {
            background: var(--background-color);
            color: var(--primary-color);
        }

        .menu-item.active {
            background: var(--primary-color);
            color: white;
        }

        .menu-item i {
            width: 24px;
            text-align: center;
        }

        /* Ana İçerik Alanı */
        .main-content {
            padding: 20px;
            overflow-x: hidden;
        }

        /* İstatistik Kartları */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 2px 4px var(--shadow-color);
            transition: transform var(--transition-speed);
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-info {
            flex: 1;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Filtre Çubuğu */
        .filters-bar {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            box-shadow: 0 2px 4px var(--shadow-color);
        }

        .filter-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-button {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            background: var(--background-color);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-speed);
        }

        .filter-button:hover {
            background: var(--primary-light);
            color: white;
        }

        .filter-button.active {
            background: var(--primary-color);
            color: white;
        }

        /* Ürün Listesi */
        .product-container {
            margin-top: 20px;
        }

        .product-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .product-card {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 2px 4px var(--shadow-color);
            transition: all var(--transition-speed);
            position: relative;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        .image-container {
            width: 100%;
            height: 200px;
            background: var(--background-color);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .product-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: transform var(--transition-speed);
        }

        .product-card:hover .product-image {
            transform: scale(1.1);
        }

        .product-info {
            padding: 20px;
        }

        .product-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            height: 3em;
        }

        .product-code {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            margin-bottom: 15px;
            padding: 8px;
            background: var(--background-color);
            border-radius: 8px;
        }

        .product-actions {
            display: flex;
            gap: 10px;
        }

        .action-button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all var(--transition-speed);
            font-weight: 500;
        }

        .copy-button {
            background: var(--primary-color);
            color: white;
        }

        .copy-button:hover {
            background: var(--primary-dark);
        }

        .favorite-button {
            background: var(--background-color);
            color: var(--text-secondary);
        }

        .favorite-button.active {
            background: var(--error-color);
            color: white;
        }

        /* Toast Bildirimleri */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: var(--surface-color);
            color: var(--text-primary);
            padding: 15px 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px var(--shadow-color);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease forwards;
            max-width: 400px;
        }

        .toast.success { border-left: 4px solid var(--success-color); }
        .toast.error { border-left: 4px solid var(--error-color); }
        .toast.warning { border-left: 4px solid var(--warning-color); }
        .toast.info { border-left: 4px solid var(--info-color); }

        /* Loading Spinner */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--surface-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Animasyonlar */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive Tasarım */
        @media (max-width: 1200px) {
            .app-container {
                grid-template-columns: 1fr;
            }

            .side-menu {
                position: fixed;
                left: 0;
                transform: translateX(-100%);
                z-index: 1000;
            }

            .side-menu.active {
                transform: translateX(0);
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                padding: 10px 0;
            }

            .header-center {
                width: 100%;
                margin: 10px 0;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .product-list {
                grid-template-columns: 1fr;
            }
        }

        /* Özel Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--background-color);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="header-left">
                    <button id="menuToggle" class="header-button">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="header-title">
                        <i class="fas fa-shopping-cart"></i>
                        <h1>Migros Ürün Sistemi Pro</h1>
                    </div>
                </div>
                <div class="header-center">
                    <div class="search-wrapper">
                        <input type="text" id="searchInput" class="search-bar" 
                               placeholder="Ürün adı, kasa kodu veya barkod ile arama yapın...">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                </div>
                <div class="header-right">
                    <button id="syncButton" class="header-button" title="Verileri Güncelle">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button id="themeToggle" class="header-button" title="Tema Değiştir">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button id="settingsButton" class="header-button" title="Ayarlar">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Yan Menü -->
        <nav id="sideMenu" class="side-menu">
            <div class="menu-header">
                <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAOxAAADsQBlSsOGwAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAMNSURBVGiB7Zhfb9NAEMXXdv6QNqEpVEiIj8AH5wvzEXgBCYkHhISERB+RgBYakpKmSRPb92BfWl/txbF9tgtCO0+O7vbO/HzendnbM/wzZa+8/sDMnwBgxswAACLSABqSLwBqZk4B1AAghACSFTNXzPxC8lcVxRbAD2ZekHwvIn0R6QKY9vv9m+Vy+Q7AJwDvAYyYeQygISKjEMLIWvvFWvvVWvvNWvvdWvvDWrtg5rn9a2bPzFNr7Zdw6kQVRbEoiuL+cDi8rqrqtYhcMfPEWvvOWvvRWvvZWvvFWvutKIofRVEsrbXzEMLcWvsTwNxa+5OZ76y1dyGEWQjhLoQwK8tyGkKYVlU1qapqUlXVuCzLcVmW47Isx1VVjas/ej0ej0upqsoAKL0PUkQaAEaSHABYZp4AeBVCGDHzmJnHzDwGMGLmETOPQggjZh4z84SZJwDGzDwWkXEIYRRCGInImJnHIYQxgDEzj0MIoxDCyDk3ds6NnXPjEMLIOTd2zo2dc+MQwtg5N3bOjZxzI+fcyDk3ds6NnHNvQwhvnXMj59yImUfMPGLmkXNu5JwbOedGIYSxc27snBuHEEbOuXEIYRxCGDvnxiGEkXNu7JwbhxDGzrkxM4+dc2Pn3BiARqABYESkEZEGM2sRaYhIg5k1M2sRaTCzFpEGM2sRaTCzBqBFpEHyJTNrAFpEGsysRaQhIg1m1iLSYGYtIg1m1iLSYGYtIg1m1sysmVkzsxaRBjNrEWkwsxaRBjNrEWkwsxaRBjNrZtYi0mBmLSINZtYi0mBmLSINZtbMrEWkwcxaRBrMrEWkwcxaRBrMrEWkwcxaRBrMrJlZM7MWkQYzaxFpMLMWkQYzaxFpMLMWkQYzaxFpMLMWkQYzaxFpMLNmZi0iDWbWItJgZi0iDWbWItJgZi0iDWbWItJgZi0iDWbWItJgZs3MWkQazKxFpMHMWkQazKxFpMHMWkQazKxFpMHMWkQazKxFpMHMmpk1M2sRaTCzFpEGM2sRaTCzFpEGM2sRaTCzFpEGM2sRaTCzFpHGX7H/x+Qvq6LvMjcAiFsAAAAASUVORK5CYII=" alt="Logo" class="menu-logo">
                <span class="menu-title">Menü</span>
            </div>
            <ul class="menu-items">
                <li class="menu-item active" data-view="products">
                    <i class="fas fa-box"></i>
                    <span>Ürünler</span>
                </li>
                <li class="menu-item" data-view="favorites">
                    <i class="fas fa-heart"></i>
                    <span>Favoriler</span>
                    <span class="badge" id="favCount">0</span>
                </li>
                <li class="menu-item" data-view="history">
                    <i class="fas fa-history"></i>
                    <span>Geçmiş</span>
                </li>
                <li class="menu-item" data-view="statistics">
                    <i class="fas fa-chart-bar"></i>
                    <span>İstatistikler</span>
                </li>
            </ul>
        </nav>

        <!-- Ana İçerik -->
        <main class="main-content">
            <!-- İstatistik Kartları -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-boxes"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="totalProducts">0</div>
                        <div class="stat-label">Toplam Ürün</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-images"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="withImage">0</div>
                        <div class="stat-label">Görselli Ürün</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="searchResults">0</div>
                        <div class="stat-label">Arama Sonucu</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-heart"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="favoriteCount">0</div>
                        <div class="stat-label">Favori Ürün</div>
                    </div>
                </div>
            </div>

            <!-- Filtreler -->
            <div class="filters-bar">
                <div class="filter-group">
                    <button class="filter-button active" data-filter="all">Tümü</button>
                    <button class="filter-button" data-filter="with-image">Görselli</button>
                    <button class="filter-button" data-filter="no-image">Görselsiz</button>
                    <button class="filter-button" data-filter="favorites">Favoriler</button>
                </div>
                <div class="sort-group">
                    <select id="sortSelect" class="filter-button">
                        <option value="name-asc">İsim (A-Z)</option>
                        <option value="name-desc">İsim (Z-A)</option>
                        <option value="code-asc">Kod (Artan)</option>
                        <option value="code-desc">Kod (Azalan)</option>
                    </select>
                </div>
            </div>

            <!-- Ürün Listesi -->
            <div class="product-container">
                <div id="productList" class="product-list"></div>
            </div>
        </main>
    </div>

    <!-- Bildirimler -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Loading Spinner -->
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
    </div>

<script>
// IndexedDB Yapılandırması
const DB_NAME = 'MigrosDB';
const DB_VERSION = 1;
const STORES = {
    products: 'products',
    favorites: 'favorites',
    history: 'searchHistory',
    settings: 'settings'
};

// IndexedDB Başlatma
let db;
const initDB = () => {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
            db = request.result;
            resolve(db);
        };

        request.onupgradeneeded = (event) => {
            const db = event.target.result;

            // Ürünler store
            if (!db.objectStoreNames.contains(STORES.products)) {
                db.createObjectStore(STORES.products, { keyPath: 'kasaKodu' });
            }

            // Favoriler store
            if (!db.objectStoreNames.contains(STORES.favorites)) {
                db.createObjectStore(STORES.favorites, { keyPath: 'kasaKodu' });
            }

            // Arama geçmişi store
            if (!db.objectStoreNames.contains(STORES.history)) {
                const historyStore = db.createObjectStore(STORES.history, { keyPath: 'timestamp' });
                historyStore.createIndex('query', 'query', { unique: false });
            }

            // Ayarlar store
            if (!db.objectStoreNames.contains(STORES.settings)) {
                db.createObjectStore(STORES.settings, { keyPath: 'key' });
            }
        };
    });
};

// Veri İşlemleri
const DataService = {
    async saveProducts(products) {
        const store = db.transaction(STORES.products, 'readwrite').objectStore(STORES.products);
        for (let product of products) {
            await store.put(product);
        }
    },

    async getProducts() {
        return new Promise((resolve, reject) => {
            const store = db.transaction(STORES.products, 'readonly').objectStore(STORES.products);
            const request = store.getAll();

            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    },

    async toggleFavorite(product) {
        const store = db.transaction(STORES.favorites, 'readwrite').objectStore(STORES.favorites);
        const request = store.get(product.kasaKodu);

        return new Promise((resolve, reject) => {
            request.onsuccess = () => {
                if (request.result) {
                    store.delete(product.kasaKodu).onsuccess = () => resolve(false);
                } else {
                    store.put(product).onsuccess = () => resolve(true);
                }
            };
            request.onerror = () => reject(request.error);
        });
    },

    async getFavorites() {
        return new Promise((resolve, reject) => {
            const store = db.transaction(STORES.favorites, 'readonly').objectStore(STORES.favorites);
            const request = store.getAll();

            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    },

    async addToHistory(query) {
        const store = db.transaction(STORES.history, 'readwrite').objectStore(STORES.history);
        const entry = {
            timestamp: Date.now(),
            query: query
        };
        await store.put(entry);
    },

    async getHistory() {
        return new Promise((resolve, reject) => {
            const store = db.transaction(STORES.history, 'readonly').objectStore(STORES.history);
            const request = store.getAll();

            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }
};

// UI İşlemleri
const UI = {
    showLoading() {
        document.getElementById('loading').style.display = 'flex';
    },

    hideLoading() {
        document.getElementById('loading').style.display = 'none';
    },

    showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 
                           type === 'error' ? 'exclamation-circle' : 
                           type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
            <span>${message}</span>
        `;
        
        document.getElementById('toastContainer').appendChild(toast);
        
        setTimeout(() => {
            toast.classList.add('fade-out');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    },

    async updateStats() {
        const products = await DataService.getProducts();
        const favorites = await DataService.getFavorites();
        
        document.getElementById('totalProducts').textContent = products.length;
        document.getElementById('withImage').textContent = products.filter(p => p.urunGorseli).length;
        document.getElementById('favoriteCount').textContent = favorites.length;
    },

    async renderProducts(products) {
        const productList = document.getElementById('productList');
        const favorites = await DataService.getFavorites();
        const favoriteIds = new Set(favorites.map(f => f.kasaKodu));
        
        productList.innerHTML = '';

        if (!products || products.length === 0) {
            productList.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 50px;">
                    <i class="fas fa-search fa-3x" style="color: var(--text-secondary);"></i>
                    <p style="margin-top: 20px; color: var(--text-secondary);">Ürün bulunamadı.</p>
                </div>`;
            return;
        }

        products.forEach(product => {
            const card = document.createElement('div');
            card.className = 'product-card animate__animated animate__fadeIn';

            const isFavorite = favoriteIds.has(product.kasaKodu);
            
            card.innerHTML = `
                ${product.urunGorseli ? `
                    <div class="image-container">
                        <img 
                            class="product-image" 
                            src="${product.urunGorseli}"
                            alt="${product.urunAdi}"
                            onerror="this.parentElement.style.display='none';"
                        >
                    </div>
                ` : ''}
                <div class="product-info">
                    <h3 class="product-name">${product.urunAdi}</h3>
                    <div class="product-code">
                        <i class="fas fa-barcode"></i>
                        ${product.kasaKodu}
                    </div>
                    <div class="product-actions">
                        <button class="action-button copy-button" onclick="App.copyToClipboard('${product.kasaKodu}')">
                            <i class="far fa-copy"></i>
                            Kopyala
                        </button>
                        <button class="action-button favorite-button ${isFavorite ? 'active' : ''}" 
                                onclick="App.toggleFavorite('${product.kasaKodu}')">
                            <i class="fas fa-heart"></i>
                        </button>
                    </div>
                </div>
            `;
            
            productList.appendChild(card);
        });

        document.getElementById('searchResults').textContent = products.length;
    }
};
// Ana Uygulama Modülü
const App = {
    currentProducts: [],
    currentFilter: 'all',
    currentSort: 'name-asc',
    searchTimeout: null,

    async init() {
        try {
            UI.showLoading();
            await initDB();
            await this.loadProducts();
            this.setupEventListeners();
            UI.updateStats();
            this.setupTheme();
            this.setupServiceWorker();
        } catch (error) {
            console.error('Uygulama başlatılamadı:', error);
            UI.showToast('Uygulama başlatılırken bir hata oluştu', 'error');
        } finally {
            UI.hideLoading();
        }
    },

    async loadProducts() {
        try {
            let products = await DataService.getProducts();
            
            if (products.length === 0) {
                UI.showLoading();
                const response = await fetch('https://raw.githubusercontent.com/migros1/mkasa/refs/heads/main/urunler.txt');
                if (!response.ok) throw new Error('Ürünler yüklenemedi');
                
                const text = await response.text();
                products = text.trim().split('\n').map(line => {
                    const [urunAdi, kasaKodu, urunGorseli] = line.split('-').map(part => part.trim());
                    return {
                        urunAdi: urunAdi || 'İsimsiz Ürün',
                        kasaKodu: kasaKodu || 'Kod Yok',
                        urunGorseli: this.formatImageUrl(urunGorseli)
                    };
                });

                await DataService.saveProducts(products);
                UI.showToast('Ürünler başarıyla yüklendi', 'success');
            }

            this.currentProducts = products;
            await this.filterAndSortProducts();
        } catch (error) {
            console.error('Ürünler yüklenirken hata:', error);
            UI.showToast('Ürünler yüklenirken bir hata oluştu', 'error');
        }
    },

    formatImageUrl(url) {
        if (!url) return '';
        url = url.trim();
        if (!url) return '';

        // URL'deki boşlukları ve özel karakterleri temizle
        url = url.replace(/\s+/g, '')
                 .replace(/[\u200B-\u200D\uFEFF]/g, '');

        // URL'nin başında http veya https yoksa ekle
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
            url = 'https://' + url;
        }

        try {
            new URL(url);
            return url;
        } catch (e) {
            console.error('Geçersiz URL:', url);
            return '';
        }
    },

    async filterAndSortProducts() {
        let filteredProducts = [...this.currentProducts];

        // Filtreleme
        switch (this.currentFilter) {
            case 'with-image':
                filteredProducts = filteredProducts.filter(p => p.urunGorseli);
                break;
            case 'no-image':
                filteredProducts = filteredProducts.filter(p => !p.urunGorseli);
                break;
            case 'favorites':
                const favorites = await DataService.getFavorites();
                const favoriteIds = new Set(favorites.map(f => f.kasaKodu));
                filteredProducts = filteredProducts.filter(p => favoriteIds.has(p.kasaKodu));
                break;
        }

        // Arama filtresi
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        if (searchTerm) {
            filteredProducts = filteredProducts.filter(product => 
                product.urunAdi.toLowerCase().includes(searchTerm) ||
                product.kasaKodu.toLowerCase().includes(searchTerm)
            );
        }

        // Sıralama
        switch (this.currentSort) {
            case 'name-asc':
                filteredProducts.sort((a, b) => a.urunAdi.localeCompare(b.urunAdi));
                break;
            case 'name-desc':
                filteredProducts.sort((a, b) => b.urunAdi.localeCompare(a.urunAdi));
                break;
            case 'code-asc':
                filteredProducts.sort((a, b) => a.kasaKodu.localeCompare(b.kasaKodu));
                break;
            case 'code-desc':
                filteredProducts.sort((a, b) => b.kasaKodu.localeCompare(a.kasaKodu));
                break;
        }

        await UI.renderProducts(filteredProducts);
    },

    setupEventListeners() {
        // Arama işlemi
        document.getElementById('searchInput').addEventListener('input', (e) => {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
                this.filterAndSortProducts();
                if (e.target.value) {
                    DataService.addToHistory(e.target.value);
                }
            }, 300);
        });

        // Filtre butonları
        document.querySelectorAll('.filter-button').forEach(button => {
            button.addEventListener('click', () => {
                if (button.dataset.filter) {
                    document.querySelectorAll('.filter-button').forEach(btn => 
                        btn.classList.remove('active'));
                    button.classList.add('active');
                    this.currentFilter = button.dataset.filter;
                    this.filterAndSortProducts();
                }
            });
        });

        // Sıralama seçeneği
        document.getElementById('sortSelect').addEventListener('change', (e) => {
            this.currentSort = e.target.value;
            this.filterAndSortProducts();
        });

        // Menü toggle
        document.getElementById('menuToggle').addEventListener('click', () => {
            document.getElementById('sideMenu').classList.toggle('active');
        });

        // Tema toggle
        document.getElementById('themeToggle').addEventListener('click', () => {
            this.toggleTheme();
        });

        // Senkronizasyon butonu
        document.getElementById('syncButton').addEventListener('click', async () => {
            try {
                UI.showLoading();
                await this.loadProducts();
                UI.showToast('Veriler güncellendi', 'success');
            } catch (error) {
                UI.showToast('Güncelleme başarısız', 'error');
            } finally {
                UI.hideLoading();
            }
        });

        // Menü öğeleri
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.menu-item').forEach(i => 
                    i.classList.remove('active'));
                item.classList.add('active');
                this.handleMenuClick(item.dataset.view);
            });
        });
    },

    async toggleFavorite(kasaKodu) {
        try {
            const product = this.currentProducts.find(p => p.kasaKodu === kasaKodu);
            if (!product) return;

            const isFavorite = await DataService.toggleFavorite(product);
            UI.showToast(
                isFavorite ? 'Favorilere eklendi' : 'Favorilerden çıkarıldı',
                'success'
            );
            await this.filterAndSortProducts();
            await UI.updateStats();
        } catch (error) {
            UI.showToast('İşlem başarısız', 'error');
        }
    },

    async copyToClipboard(text) {
        try {
            await navigator.clipboard.writeText(text);
            UI.showToast('Kasa kodu kopyalandı', 'success');
        } catch (error) {
            UI.showToast('Kopyalama başarısız', 'error');
        }
    },

    setupTheme() {
        const isDark = localStorage.getItem('darkMode') === 'true';
        if (isDark) {
            document.body.setAttribute('data-theme', 'dark');
            document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i>';
        }
    },

    toggleTheme() {
        const isDark = document.body.getAttribute('data-theme') === 'dark';
        document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
        localStorage.setItem('darkMode', !isDark);
        document.getElementById('themeToggle').innerHTML = 
            `<i class="fas fa-${isDark ? 'moon' : 'sun'}"></i>`;
    },

    async handleMenuClick(view) {
        switch (view) {
            case 'products':
                this.currentFilter = 'all';
                document.querySelector('[data-filter="all"]').click();
                break;
            case 'favorites':
                this.currentFilter = 'favorites';
                await this.filterAndSortProducts();
                break;
            case 'history':
                const history = await DataService.getHistory();
                // Geçmiş görünümünü göster
                break;
            case 'statistics':
                // İstatistik görünümünü göster
                break;
        }
    },

    async setupServiceWorker() {
        if ('serviceWorker' in navigator) {
            try {
                const registration = await navigator.serviceWorker.register('/sw.js');
                console.log('Service Worker başarıyla kaydedildi:', registration);
            } catch (error) {
                console.error('Service Worker kaydı başarısız:', error);
            }
        }
    }
};

// Uygulamayı başlat
document.addEventListener('DOMContentLoaded', () => App.init());

// Service Worker
const CACHE_NAME = 'migros-cache-v1';
const CACHE_URLS = [
    '/',
    '/index.html',
    '/styles/main.css',
    '/js/app.js',
    'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css',
    'https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css'
];

self.addEventListener('install', (event) => {
    event.waitUntil(
        caches.open(CACHE_NAME)
            .then(cache => cache.addAll(CACHE_URLS))
    );
});

self.addEventListener('fetch', (event) => {
    event.respondWith(
        caches.match(event.request)
            .then(response => response || fetch(event.request))
    );
});

// Offline desteği için network first stratejisi
self.addEventListener('fetch', (event) => {
    event.respondWith(
        fetch(event.request)
            .catch(() => caches.match(event.request))
    );
});
</script>
</body>
</html>